<div class="flex flex-col flex-auto min-h-0">
    <!-- Dialog header -->
    <div class="flex flex-0 items-center justify-between h-16 pr-3 sm:pr-5 pl-6 sm:pl-8 bg-gray-100 border-b">
        <div class="text-lg font-medium tracking-tight">
            {{ isEdit ? 'Edit Product' : 'Add Product' }}
        </div>
        <button
            mat-icon-button
            [matDialogClose]="undefined">
            <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
        </button>
    </div>

    <!-- Dialog content -->
    <div class="flex-auto overflow-y-auto p-6 sm:p-8">
        <form [formGroup]="productForm">
            <!-- Basic information -->
            <div class="text-xl font-medium tracking-tight leading-6 mb-6">Basic Information</div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <!-- SKU -->
                <mat-form-field class="w-full">
                    <mat-label>SKU</mat-label>
                    <input
                        matInput
                        [formControlName]="'sku'"
                        [placeholder]="'Enter SKU'">
                    <mat-error *ngIf="productForm.get('sku').hasError('required')">
                        SKU is required
                    </mat-error>
                </mat-form-field>

                <!-- Name -->
                <mat-form-field class="w-full">
                    <mat-label>Name</mat-label>
                    <input
                        matInput
                        [formControlName]="'name'"
                        [placeholder]="'Enter product name'">
                    <mat-error *ngIf="productForm.get('name').hasError('required')">
                        Name is required
                    </mat-error>
                </mat-form-field>
            </div>

            <!-- Description -->
            <mat-form-field class="w-full">
                <mat-label>Description</mat-label>
                <textarea
                    matInput
                    [formControlName]="'description'"
                    [placeholder]="'Enter product description'"
                    [rows]="3">
                </textarea>
                <mat-error *ngIf="productForm.get('description').hasError('required')">
                    Description is required
                </mat-error>
            </mat-form-field>

            <!-- Category -->
            <mat-form-field class="w-full">
                <mat-label>Category</mat-label>
                <mat-select [formControlName]="'category'">
                    <ng-container *ngFor="let category of categories; trackBy: trackByFn">
                        <mat-option [value]="category.path">{{ category.name }}</mat-option>
                        <ng-container *ngFor="let child of category.children; trackBy: trackByFn">
                            <mat-option [value]="child.path">
                                &nbsp;&nbsp;&nbsp;{{ child.name }}
                            </mat-option>
                            <ng-container *ngFor="let grandChild of child.children; trackBy: trackByFn">
                                <mat-option [value]="grandChild.path">
                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ grandChild.name }}
                                </mat-option>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </mat-select>
                <mat-error *ngIf="productForm.get('category').hasError('required')">
                    Category is required
                </mat-error>
            </mat-form-field>

            <mat-divider class="my-8"></mat-divider>

            <!-- Images -->
            <div class="text-xl font-medium tracking-tight leading-6 mb-6">Images</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 items-start">
                <div class="flex flex-col gap-4">
                    <!-- Main image -->
                    <mat-form-field class="w-full">
                        <mat-label>Main Image URL</mat-label>
                        <input
                            matInput
                            [formControlName]="'imageUrl'"
                            [placeholder]="'Enter main image URL'">
                        <mat-error *ngIf="productForm.get('imageUrl').hasError('required')">
                            Main image URL is required
                        </mat-error>
                    </mat-form-field>

                    <!-- Additional photos -->
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center justify-between">
                            <div class="font-medium">Additional Photos</div>
                            <button
                                mat-stroked-button
                                type="button"
                                (click)="addPhoto('')">
                                <mat-icon
                                    class="icon-size-5"
                                    [svgIcon]="'heroicons_mini:plus'">
                                </mat-icon>
                                <span class="ml-2">Add Photo</span>
                            </button>
                        </div>

                        <div class="flex flex-col gap-4" formArrayName="photos">
                            <div
                                *ngFor="let photo of photos.controls; let i = index"
                                class="flex items-center gap-2">
                                <mat-form-field class="flex-auto">
                                    <mat-label>Photo URL</mat-label>
                                    <input
                                        matInput
                                        [formControlName]="i"
                                        [placeholder]="'Enter photo URL'">
                                </mat-form-field>
                                <button
                                    mat-icon-button
                                    type="button"
                                    (click)="removePhoto(i)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gallery preview -->
                <div>
                    <app-image-gallery [urls]="galleryUrls"></app-image-gallery>
                </div>
            </div>

            <mat-divider class="my-8"></mat-divider>

            <!-- Pricing and inventory -->
            <div class="text-xl font-medium tracking-tight leading-6 mb-6">Pricing & Inventory</div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <!-- Price -->
                <mat-form-field class="w-full">
                    <mat-label>Price</mat-label>
                    <input
                        matInput
                        type="number"
                        [formControlName]="'price'"
                        [placeholder]="'Enter price'">
                    <span matTextPrefix>$&nbsp;</span>
                    <mat-error *ngIf="productForm.get('price').hasError('required')">
                        Price is required
                    </mat-error>
                    <mat-error *ngIf="productForm.get('price').hasError('min')">
                        Price must be greater than or equal to 0
                    </mat-error>
                </mat-form-field>

                <!-- Sale price -->
                <mat-form-field class="w-full">
                    <mat-label>Sale Price (Optional)</mat-label>
                    <input
                        matInput
                        type="number"
                        [formControlName]="'salePrice'"
                        [placeholder]="'Enter sale price'">
                    <span matTextPrefix>$&nbsp;</span>
                </mat-form-field>
            </div>

            <mat-divider class="my-8"></mat-divider>

            <!-- Attributes -->
            <div class="flex flex-col gap-2">
                <div class="flex items-center justify-between">
                    <div class="text-xl font-medium tracking-tight leading-6">Attributes</div>
                    <div class="flex items-center gap-2">
                        <mat-form-field class="w-48">
                            <mat-label>Key</mat-label>
                            <input
                                #attributeKey
                                matInput
                                [placeholder]="'Enter attribute key'">
                        </mat-form-field>
                        <mat-form-field class="w-48">
                            <mat-label>Value</mat-label>
                            <input
                                #attributeValue
                                matInput
                                [placeholder]="'Enter attribute value'">
                        </mat-form-field>
                        <button
                            mat-stroked-button
                            type="button"
                            (click)="addAttribute(attributeKey.value, attributeValue.value); attributeKey.value = ''; attributeValue.value = ''">
                            <mat-icon
                                class="icon-size-5"
                                [svgIcon]="'heroicons_mini:plus'">
                            </mat-icon>
                            <span class="ml-2">Add</span>
                        </button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2" formGroupName="attributes">
                    <mat-chip-set>
                        <mat-chip
                            *ngFor="let attribute of productForm.get('attributes').value | keyvalue"
                            [removable]="true"
                            (removed)="removeAttribute(attribute.key)">
                            <strong>{{ attribute.key }}:</strong> {{ attribute.value }}
                            <mat-icon matChipRemove>cancel</mat-icon>
                        </mat-chip>
                    </mat-chip-set>
                </div>
            </div>
        </form>
    </div>

    <!-- Dialog footer -->
    <div class="sticky bottom-0 flex items-center justify-end gap-2 px-6 py-4 border-t bg-gray-50 z-50">
        <button
            mat-button
            [matDialogClose]="undefined">
            Cancel
        </button>
        <button
            mat-flat-button
            [color]="'primary'"
            [disabled]="productForm.invalid"
            (click)="saveProduct()">
            {{ isEdit ? 'Save' : 'Create' }}
        </button>
    </div>
</div>
